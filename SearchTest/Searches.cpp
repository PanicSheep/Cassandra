#include "pch.h"

const PositionScore Zero_empty_0 = {
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"O O O O O O O O"_pos, 0 };

const PositionScore Zero_empty_1 = {
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"X X X X X X X X"_pos, +16 };

const PositionScore Zero_empty_2 = {
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"O O O O O O O O"
	"X X X X X X X X"
	"O O O O O O O O"
	"O O O O O O O O"
	"O O O O O O O O"_pos, -16 };

const PositionScore One_empty_0 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X -"_pos, +64 };

const PositionScore One_empty_1 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X O O"
	"X X X X X X O -"_pos, +64 };

const PositionScore One_empty_2 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"O X X X X X X -"_pos, +48 };

const PositionScore One_empty_3 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X O"
	"O X X X X X X -"_pos, +62 };

const PositionScore Two_empty_0 = {
	"X X X X X X X -"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X -"_pos, +64 };

const PositionScore Two_empty_1 = {
	"X X X X X X O -"
	"X X X X X X O O"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X O O"
	"X X X X X X O -"_pos, +64 };

const PositionScore Two_empty_2 = {
	"X X X X X X X  "
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"O X X X X X X -"_pos, +22 };

const PositionScore Two_empty_3 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X O X X"
	"X X X X X X X O"
	"X X X X X X O -"
	"O X X X X X X -"_pos, +54 };

const PositionScore Three_empty_0 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X - - -"_pos, +64 };

const PositionScore Three_empty_1 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X O X"
	"X X X X X - - -"_pos, +64 };

const PositionScore Three_empty_2 = {
	"X X X X X O O O"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X - - -"_pos, +16 };

const PositionScore Three_empty_3 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X O"
	"X X X X X O X X"
	"X X X X X X X -"
	"X X X X X X O -"
	"O X X X X X X -"_pos, +58 };

const PositionScore Four_empty_0 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X - - - -"_pos, +64 };

const PositionScore Four_empty_1 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X O O O O O"
	"X X X O - - - -"_pos, +64 };

const PositionScore Four_empty_2 = {
	"X X X X O O O O"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X - - - -"_pos, +0 };

const PositionScore Four_empty_3 = {
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X O O X X X"
	"X X O X X O X X"
	"X X - - - - X X"_pos, +56 };


const PositionScore Five_empty = {
	"X X X X X X X -"
	"X X X X X X X O"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X X X X X X X X"
	"X O X O X O X O"
	"X - X - X - X -"_pos, +64 };


class NegaMax : public ::testing::Test
{
public:
	void Test(PositionScore pos_score)
	{
		const Position pos = pos_score.pos;
		const Score correct = pos_score.score;

		const auto result = Search::NegaMax{}.Eval(pos, Search::Intensity::Exact(pos));
				
		ASSERT_EQ(result.window.lower(), correct);
		ASSERT_EQ(result.window.upper(), correct);
	}
};

TEST_F(NegaMax, Zero_empty_0) { Test(Zero_empty_0); }
TEST_F(NegaMax, Zero_empty_1) { Test(Zero_empty_1); }
TEST_F(NegaMax, Zero_empty_2) { Test(Zero_empty_2); }
TEST_F(NegaMax, One_empty_0) { Test(One_empty_0); }
TEST_F(NegaMax, One_empty_1) { Test(One_empty_1); }
TEST_F(NegaMax, One_empty_2) { Test(One_empty_2); }
TEST_F(NegaMax, One_empty_3) { Test(One_empty_3); }
TEST_F(NegaMax, Two_empty_0) { Test(Two_empty_0); }
TEST_F(NegaMax, Two_empty_1) { Test(Two_empty_1); }
TEST_F(NegaMax, Two_empty_2) { Test(Two_empty_2); }
TEST_F(NegaMax, Two_empty_3) { Test(Two_empty_3); }
TEST_F(NegaMax, Three_empty_0) { Test(Three_empty_0); }
TEST_F(NegaMax, Three_empty_1) { Test(Three_empty_1); }
TEST_F(NegaMax, Three_empty_2) { Test(Three_empty_2); }
TEST_F(NegaMax, Three_empty_3) { Test(Three_empty_3); }
TEST_F(NegaMax, Four_empty_0) { Test(Four_empty_0); }
TEST_F(NegaMax, Four_empty_1) { Test(Four_empty_1); }
TEST_F(NegaMax, Four_empty_2) { Test(Four_empty_2); }
TEST_F(NegaMax, Four_empty_3) { Test(Four_empty_3); }
TEST_F(NegaMax, Five_empty) { Test(Five_empty); }


class AlphaBetaFailHard : public ::testing::Test
{
public:
	void Test(const Position& pos, const Score& correct, const OpenInterval& requested)
	{
		const auto result = Search::AlphaBetaFailHard{}.Eval(pos, Search::Intensity(requested, pos.EmptyCount(), Search::Selectivity::None));

		ASSERT_TRUE(result.window.Contains(correct));

		if (correct < requested) // fail low
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// ----[]------------------- correct
			// [--------]--------------- result
			ASSERT_EQ(result.window.lower(), min_score);
			ASSERT_EQ(result.window.upper(), requested.lower());
		}
		else if (requested < correct) // fail high
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// -------------------[]---- correct
			// ---------------[--------] result
			ASSERT_EQ(result.window.lower(), requested.upper());
			ASSERT_EQ(result.window.upper(), max_score);
		}
		else // score found
		{
			ASSERT_EQ(result.window.lower(), correct);
			ASSERT_EQ(result.window.upper(), correct);
		}
	}

	void Test(const PositionScore& pos)
	{
		Test(pos.pos, pos.score, OpenInterval::Whole());
	}

	void Test_all_windows(const Position& pos, const Score& correct)
	{
		for (int lower : range(min_score, max_score + 1))
			for (int upper : range(lower + 1, max_score + 1))
				Test(pos, correct, { lower, upper });
	}

	void Test_all_windows(const PositionScore& pos)
	{
		Test_all_windows(pos.pos, pos.score);
	}
};

TEST_F(AlphaBetaFailHard, Zero_empty_0) { Test_all_windows(Zero_empty_0); }
TEST_F(AlphaBetaFailHard, Zero_empty_1) { Test_all_windows(Zero_empty_1); }
TEST_F(AlphaBetaFailHard, Zero_empty_2) { Test_all_windows(Zero_empty_2); }
TEST_F(AlphaBetaFailHard, One_empty_0) { Test_all_windows(One_empty_0); }
TEST_F(AlphaBetaFailHard, One_empty_1) { Test_all_windows(One_empty_1); }
TEST_F(AlphaBetaFailHard, One_empty_2) { Test_all_windows(One_empty_2); }
TEST_F(AlphaBetaFailHard, One_empty_3) { Test_all_windows(One_empty_3); }
TEST_F(AlphaBetaFailHard, Two_empty_0) { Test_all_windows(Two_empty_0); }
TEST_F(AlphaBetaFailHard, Two_empty_1) { Test_all_windows(Two_empty_1); }
TEST_F(AlphaBetaFailHard, Two_empty_2) { Test_all_windows(Two_empty_2); }
TEST_F(AlphaBetaFailHard, Two_empty_3) { Test_all_windows(Two_empty_3); }
TEST_F(AlphaBetaFailHard, Three_empty_0) { Test_all_windows(Three_empty_0); }
TEST_F(AlphaBetaFailHard, Three_empty_1) { Test_all_windows(Three_empty_1); }
TEST_F(AlphaBetaFailHard, Three_empty_2) { Test_all_windows(Three_empty_2); }
TEST_F(AlphaBetaFailHard, Three_empty_3) { Test_all_windows(Three_empty_3); }
TEST_F(AlphaBetaFailHard, Four_empty_0) { Test_all_windows(Four_empty_0); }
TEST_F(AlphaBetaFailHard, Four_empty_1) { Test_all_windows(Four_empty_1); }
TEST_F(AlphaBetaFailHard, Four_empty_2) { Test_all_windows(Four_empty_2); }
TEST_F(AlphaBetaFailHard, Four_empty_3) { Test_all_windows(Four_empty_3); }
TEST_F(AlphaBetaFailHard, Five_empty) { Test_all_windows(Five_empty); }
TEST_F(AlphaBetaFailHard, FForum_1) { Test(FForum[1]); }
TEST_F(AlphaBetaFailHard, FForum_2) { Test(FForum[2]); }
TEST_F(AlphaBetaFailHard, FForum_3) { Test(FForum[3]); }
TEST_F(AlphaBetaFailHard, FForum_4) { Test(FForum[4]); }
TEST_F(AlphaBetaFailHard, FForum_5) { Test(FForum[5]); }
TEST_F(AlphaBetaFailHard, FForum_6) { Test(FForum[6]); }
TEST_F(AlphaBetaFailHard, FForum_7) { Test(FForum[7]); }
TEST_F(AlphaBetaFailHard, FForum_8) { Test(FForum[8]); }
TEST_F(AlphaBetaFailHard, FForum_9) { Test(FForum[9]); }
TEST_F(AlphaBetaFailHard, FForum_10) { Test(FForum[10]); }


class AlphaBetaFailSoft : public ::testing::Test
{
public:
	void Test(const Position& pos, const Score& correct, const OpenInterval& requested)
	{
		const auto result = Search::AlphaBetaFailSoft{}.Eval(pos, Search::Intensity(requested, pos.EmptyCount(), Search::Selectivity::None));

		ASSERT_TRUE(result.window.Contains(correct));
		
		if (correct < requested) // fail low
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// ----[]------------------- correct
			// [----]]]]]--------------- result
			ASSERT_EQ(min_score, result.window.lower());

			ASSERT_LE(correct, result.window.upper());
			ASSERT_LE(result.window.upper(), requested.lower());
		}
		else if (requested < correct) // fail high
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// -------------------[]---- correct
			// ---------------[[[[[----] result
			ASSERT_LE(requested.upper(), result.window.lower());
			ASSERT_LE(result.window.lower(), correct);

			ASSERT_EQ(result.window.upper(), max_score);
		}
		else // score found
		{
			ASSERT_EQ(result.window.lower(), correct);
			ASSERT_EQ(result.window.upper(), correct);
		}
	}

	void Test(const PositionScore& pos)
	{
		Test(pos.pos, pos.score, OpenInterval::Whole());
	}

	void Test_all_windows(const Position& pos, const Score& correct)
	{
		for (int lower : range(min_score, max_score + 1))
			for (int upper : range(lower + 1, max_score + 1))
				Test(pos, correct, { lower, upper });
	}

	void Test_all_windows(const PositionScore& pos)
	{
		Test_all_windows(pos.pos, pos.score);
	}
};

TEST_F(AlphaBetaFailSoft, Zero_empty_0) { Test_all_windows(Zero_empty_0); }
TEST_F(AlphaBetaFailSoft, Zero_empty_1) { Test_all_windows(Zero_empty_1); }
TEST_F(AlphaBetaFailSoft, Zero_empty_2) { Test_all_windows(Zero_empty_2); }
TEST_F(AlphaBetaFailSoft, One_empty_0) { Test_all_windows(One_empty_0); }
TEST_F(AlphaBetaFailSoft, One_empty_1) { Test_all_windows(One_empty_1); }
TEST_F(AlphaBetaFailSoft, One_empty_2) { Test_all_windows(One_empty_2); }
TEST_F(AlphaBetaFailSoft, One_empty_3) { Test_all_windows(One_empty_3); }
TEST_F(AlphaBetaFailSoft, Two_empty_0) { Test_all_windows(Two_empty_0); }
TEST_F(AlphaBetaFailSoft, Two_empty_1) { Test_all_windows(Two_empty_1); }
TEST_F(AlphaBetaFailSoft, Two_empty_2) { Test_all_windows(Two_empty_2); }
TEST_F(AlphaBetaFailSoft, Two_empty_3) { Test_all_windows(Two_empty_3); }
TEST_F(AlphaBetaFailSoft, Three_empty_0) { Test_all_windows(Three_empty_0); }
TEST_F(AlphaBetaFailSoft, Three_empty_1) { Test_all_windows(Three_empty_1); }
TEST_F(AlphaBetaFailSoft, Three_empty_2) { Test_all_windows(Three_empty_2); }
TEST_F(AlphaBetaFailSoft, Three_empty_3) { Test_all_windows(Three_empty_3); }
TEST_F(AlphaBetaFailSoft, Four_empty_0) { Test_all_windows(Four_empty_0); }
TEST_F(AlphaBetaFailSoft, Four_empty_1) { Test_all_windows(Four_empty_1); }
TEST_F(AlphaBetaFailSoft, Four_empty_2) { Test_all_windows(Four_empty_2); }
TEST_F(AlphaBetaFailSoft, Four_empty_3) { Test_all_windows(Four_empty_3); }
TEST_F(AlphaBetaFailSoft, Five_empty) { Test_all_windows(Five_empty); }
TEST_F(AlphaBetaFailSoft, FForum_1) { Test(FForum[1]); }
TEST_F(AlphaBetaFailSoft, FForum_2) { Test(FForum[2]); }
TEST_F(AlphaBetaFailSoft, FForum_3) { Test(FForum[3]); }
TEST_F(AlphaBetaFailSoft, FForum_4) { Test(FForum[4]); }
TEST_F(AlphaBetaFailSoft, FForum_5) { Test(FForum[5]); }
TEST_F(AlphaBetaFailSoft, FForum_6) { Test(FForum[6]); }
TEST_F(AlphaBetaFailSoft, FForum_7) { Test(FForum[7]); }
TEST_F(AlphaBetaFailSoft, FForum_8) { Test(FForum[8]); }
TEST_F(AlphaBetaFailSoft, FForum_9) { Test(FForum[9]); }
TEST_F(AlphaBetaFailSoft, FForum_10) { Test(FForum[10]); }

class PVSearch : public ::testing::Test
{
public:
	HashTablePVS tt{ 1 };

	void Test(const Position& pos, const Score& correct, const OpenInterval& requested)
	{
		const auto result = Search::PVSearch{ tt }.Eval(pos, Search::Intensity(requested, pos.EmptyCount(), Search::Selectivity::None));

		ASSERT_TRUE(result.window.Contains(correct));

		if (correct < requested) // fail low
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// ----[]------------------- correct
			// [[[[[]]]]]--------------- result
			ASSERT_LE(min_score, result.window.lower());
			ASSERT_LE(result.window.lower(), correct);

			ASSERT_LE(correct, result.window.upper());
			ASSERT_LE(result.window.upper(), requested.lower());
		}
		else if (requested < correct) // fail high
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// -------------------[]---- correct
			// ---------------[[[[[]]]]] result
			ASSERT_LE(requested.upper(), result.window.lower());
			ASSERT_LE(result.window.lower(), correct);

			ASSERT_LE(correct, result.window.upper());
			ASSERT_LE(result.window.upper(), max_score);
		}
		else // score found
		{
			ASSERT_EQ(result.window.lower(), correct);
			ASSERT_EQ(result.window.upper(), correct);
		}
	}

	void Test(const PositionScore& pos)
	{
		Test(pos.pos, pos.score, OpenInterval::Whole());
	}

	void Test_all_windows(const Position& pos, const Score& correct)
	{
		for (int lower : range(min_score, max_score + 1))
			for (int upper : range(lower + 1, max_score + 1))
				Test(pos, correct, { lower, upper });
	}

	void Test_all_windows(const PositionScore& pos)
	{
		Test_all_windows(pos.pos, pos.score);
	}
};

TEST_F(PVSearch, Zero_empty_0) { Test_all_windows(Zero_empty_0); }
TEST_F(PVSearch, Zero_empty_1) { Test_all_windows(Zero_empty_1); }
TEST_F(PVSearch, Zero_empty_2) { Test_all_windows(Zero_empty_2); }
TEST_F(PVSearch, One_empty_0) { Test_all_windows(One_empty_0); }
TEST_F(PVSearch, One_empty_1) { Test_all_windows(One_empty_1); }
TEST_F(PVSearch, One_empty_2) { Test_all_windows(One_empty_2); }
TEST_F(PVSearch, One_empty_3) { Test_all_windows(One_empty_3); }
TEST_F(PVSearch, Two_empty_0) { Test_all_windows(Two_empty_0); }
TEST_F(PVSearch, Two_empty_1) { Test_all_windows(Two_empty_1); }
TEST_F(PVSearch, Two_empty_2) { Test_all_windows(Two_empty_2); }
TEST_F(PVSearch, Two_empty_3) { Test_all_windows(Two_empty_3); }
TEST_F(PVSearch, Three_empty_0) { Test_all_windows(Three_empty_0); }
TEST_F(PVSearch, Three_empty_1) { Test_all_windows(Three_empty_1); }
TEST_F(PVSearch, Three_empty_2) { Test_all_windows(Three_empty_2); }
TEST_F(PVSearch, Three_empty_3) { Test_all_windows(Three_empty_3); }
TEST_F(PVSearch, Four_empty_0) { Test_all_windows(Four_empty_0); }
TEST_F(PVSearch, Four_empty_1) { Test_all_windows(Four_empty_1); }
TEST_F(PVSearch, Four_empty_2) { Test_all_windows(Four_empty_2); }
TEST_F(PVSearch, Four_empty_3) { Test_all_windows(Four_empty_3); }
TEST_F(PVSearch, Five_empty) { Test_all_windows(Five_empty); }
TEST_F(PVSearch, FForum_1) { Test(FForum[1]); }
TEST_F(PVSearch, FForum_2) { Test(FForum[2]); }
TEST_F(PVSearch, FForum_3) { Test(FForum[3]); }
TEST_F(PVSearch, FForum_4) { Test(FForum[4]); }
TEST_F(PVSearch, FForum_5) { Test(FForum[5]); }
TEST_F(PVSearch, FForum_6) { Test(FForum[6]); }
TEST_F(PVSearch, FForum_7) { Test(FForum[7]); }
TEST_F(PVSearch, FForum_8) { Test(FForum[8]); }
TEST_F(PVSearch, FForum_9) { Test(FForum[9]); }
TEST_F(PVSearch, FForum_10) { Test(FForum[10]); }

class PVSearch_TT : public ::testing::Test
{
public:
	HashTablePVS tt{ 1'000 };
	
	void Test(const Position& pos, const Score& correct, const OpenInterval& requested)
	{
		const auto result = Search::PVSearch{ tt }.Eval(pos, Search::Intensity(requested, pos.EmptyCount(), Search::Selectivity::None));

		ASSERT_TRUE(result.window.Contains(correct));

		if (correct < requested) // fail low
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// ----[]------------------- correct
			// [[[[[]]]]]--------------- result
			ASSERT_LE(min_score, result.window.lower());
			ASSERT_LE(result.window.lower(), correct);

			ASSERT_LE(correct, result.window.upper());
			ASSERT_LE(result.window.upper(), requested.lower());
		}
		else if (requested < correct) // fail high
		{
			// [-----------------------] possible
			// ---------(-----)--------- requested
			// -------------------[]---- correct
			// ---------------[[[[[]]]]] result
			ASSERT_LE(requested.upper(), result.window.lower());
			ASSERT_LE(result.window.lower(), correct);

			ASSERT_LE(correct, result.window.upper());
			ASSERT_LE(result.window.upper(), max_score);
		}
		else // score found
		{
			ASSERT_EQ(result.window.lower(), correct);
			ASSERT_EQ(result.window.upper(), correct);
		}
	}

	void Test(const PositionScore& pos)
	{
		Test(pos.pos, pos.score, OpenInterval::Whole());
	}

	void Test_all_windows(const Position& pos, const Score& correct)
	{
		for (int lower : range(min_score, max_score + 1))
			for (int upper : range(lower + 1, max_score + 1))
				Test(pos, correct, { lower, upper });
	}

	void Test_all_windows(const PositionScore& pos)
	{
		Test_all_windows(pos.pos, pos.score);
	}
};

TEST_F(PVSearch_TT, FForum_1) { Test(FForum[1]); }
TEST_F(PVSearch_TT, FForum_2) { Test(FForum[2]); }
TEST_F(PVSearch_TT, FForum_3) { Test(FForum[3]); }
TEST_F(PVSearch_TT, FForum_4) { Test(FForum[4]); }
TEST_F(PVSearch_TT, FForum_5) { Test(FForum[5]); }
TEST_F(PVSearch_TT, FForum_6) { Test(FForum[6]); }
TEST_F(PVSearch_TT, FForum_7) { Test(FForum[7]); }
TEST_F(PVSearch_TT, FForum_8) { Test(FForum[8]); }
TEST_F(PVSearch_TT, FForum_9) { Test(FForum[9]); }
TEST_F(PVSearch_TT, FForum_10) { Test(FForum[10]); }
